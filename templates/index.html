<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Translator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 30px;
        max-width: 800px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 1.1em;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #dee2e6;
      }

      .btn-secondary:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .language-selector {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .language-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .language-group label {
        font-weight: 600;
        color: #333;
      }

      .language-group select {
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .language-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .status {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 10px;
        font-weight: 600;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.recording {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.processing {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .results {
        margin-top: 30px;
      }

      .result-item {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
        animation: fadeIn 0.5s ease-in;
      }

      .result-item:nth-child(even) {
        border-left-color: #764ba2;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .result-time {
        font-size: 12px;
        color: #666;
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 20px;
      }

      .result-text {
        margin-bottom: 10px;
      }

      .original-text {
        font-size: 16px;
        color: #333;
        margin-bottom: 8px;
      }

      .translated-text {
        font-size: 16px;
        color: #667eea;
        font-weight: 600;
      }

      .language-labels {
        display: flex;
        gap: 10px;
        font-size: 12px;
        color: #666;
      }

      .language-label {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
      }

      .recording-indicator {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      .recording-indicator.active {
        display: flex;
      }

      .pulse {
        width: 20px;
        height: 20px;
        background: #ff6b6b;
        border-radius: 50%;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .clear-btn {
        margin-top: 20px;
        background: #6c757d;
        color: white;
      }

      .clear-btn:hover {
        background: #5a6268;
      }

      @media (max-width: 600px) {
        .controls {
          flex-direction: column;
          align-items: center;
        }

        .language-selector {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸŽ¤ Voice Translator</h1>
        <p>Speak in one language, see it translated in real-time</p>
      </div>

      <div class="language-selector">
        <div class="language-group">
          <label for="sourceLanguage">From:</label>
          <select id="sourceLanguage">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ru">Russian</option>
            <option value="zh">Chinese</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="ar">Arabic</option>
            <option value="hi">Hindi</option>
          </select>
        </div>
        <div class="language-group">
          <label for="targetLanguage">To:</label>
          <select id="targetLanguage">
            <option value="es">Spanish</option>
            <option value="en">English</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ru">Russian</option>
            <option value="zh">Chinese</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="ar">Arabic</option>
            <option value="hi">Hindi</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <button id="startBtn" class="btn btn-primary">Start Recording</button>
        <button id="stopBtn" class="btn btn-danger" disabled>
          Stop Recording
        </button>
        <button id="testMicBtn" class="btn btn-secondary">
          Test Microphone
        </button>
      </div>

      <div id="recordingIndicator" class="recording-indicator">
        <div class="pulse"></div>
        <span>Recording... Speak now!</span>
      </div>

      <div id="status" class="status"></div>

      <div class="results">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3>Translation Results</h3>
          <button id="clearBtn" class="btn clear-btn">Clear Results</button>
        </div>
        <div id="results-container"></div>
      </div>
    </div>

    <script>
      class VoiceTranslator {
        constructor() {
          this.socket = io();
          this.mediaRecorder = null;
          this.audioStream = null;
          this.isRecording = false;
          this.audioChunks = [];

          this.initializeElements();
          this.setupEventListeners();
          this.setupSocketListeners();
        }

        initializeElements() {
          this.startBtn = document.getElementById("startBtn");
          this.stopBtn = document.getElementById("stopBtn");
          this.testMicBtn = document.getElementById("testMicBtn");
          this.status = document.getElementById("status");
          this.resultsContainer = document.getElementById("results-container");
          this.recordingIndicator =
            document.getElementById("recordingIndicator");
          this.sourceLanguage = document.getElementById("sourceLanguage");
          this.targetLanguage = document.getElementById("targetLanguage");
          this.clearBtn = document.getElementById("clearBtn");
        }

        setupEventListeners() {
          this.startBtn.addEventListener("click", () => this.startRecording());
          this.stopBtn.addEventListener("click", () => this.stopRecording());
          this.testMicBtn.addEventListener("click", () =>
            this.testMicrophone()
          );
          this.clearBtn.addEventListener("click", () => this.clearResults());

          this.sourceLanguage.addEventListener("change", () =>
            this.updateLanguages()
          );
          this.targetLanguage.addEventListener("change", () =>
            this.updateLanguages()
          );
        }

        setupSocketListeners() {
          this.socket.on("connect", () => {
            this.updateStatus("Connected to server", "connected");
          });

          this.socket.on("disconnect", () => {
            this.updateStatus("Disconnected from server", "error");
          });

          this.socket.on("status", (data) => {
            this.updateStatus(data.message, "processing");
          });

          this.socket.on("transcription", (data) => {
            this.displayResult(data);
          });
        }

        async startRecording() {
          try {
            this.audioStream = await navigator.mediaDevices.getUserMedia({
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 16000,
              },
            });

            this.mediaRecorder = new MediaRecorder(this.audioStream, {
              mimeType: "audio/webm",
            });

            this.mediaRecorder.ondataavailable = (event) => {
              if (event.data.size > 0) {
                this.processAudioChunk(event.data);
              }
            };

            this.mediaRecorder.start(1000); // Record in 1-second chunks
            this.isRecording = true;

            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.recordingIndicator.classList.add("active");

            this.updateStatus("Recording started - speak now!", "recording");
            this.socket.emit("start_recording");
          } catch (error) {
            console.error("Error starting recording:", error);
            this.updateStatus(
              "Error accessing microphone: " + error.message,
              "error"
            );
          }
        }

        stopRecording() {
          if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.audioStream.getTracks().forEach((track) => track.stop());
            this.isRecording = false;

            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            this.recordingIndicator.classList.remove("active");

            this.updateStatus("Recording stopped", "connected");
            this.socket.emit("stop_recording");
          }
        }

        async processAudioChunk(audioBlob) {
          try {
            const arrayBuffer = await audioBlob.arrayBuffer();
            const base64Audio = this.arrayBufferToBase64(arrayBuffer);

            this.socket.emit("audio_chunk", { audio: base64Audio });
          } catch (error) {
            console.error("Error processing audio chunk:", error);
          }
        }

        arrayBufferToBase64(buffer) {
          let binary = "";
          const bytes = new Uint8Array(buffer);
          const len = bytes.byteLength;
          for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return btoa(binary);
        }

        testMicrophone() {
          this.socket.emit("test_microphone");
        }

        updateLanguages() {
          const sourceLanguage = this.sourceLanguage.value;
          const targetLanguage = this.targetLanguage.value;

          this.socket.emit("change_language", {
            source: sourceLanguage,
            target: targetLanguage,
          });
        }

        updateStatus(message, type = "") {
          this.status.textContent = message;
          this.status.className = `status ${type}`;
        }

        displayResult(data) {
          const timestamp = new Date(
            data.timestamp * 1000
          ).toLocaleTimeString();

          const resultItem = document.createElement("div");
          resultItem.className = "result-item";
          resultItem.innerHTML = `
                    <div class="result-header">
                        <div class="language-labels">
                            <span class="language-label">${data.source_lang}</span>
                            <span>â†’</span>
                            <span class="language-label">${data.target_lang}</span>
                        </div>
                        <div class="result-time">${timestamp}</div>
                    </div>
                    <div class="result-text">
                        <div class="original-text">"${data.original}"</div>
                        <div class="translated-text">"${data.translated}"</div>
                    </div>
                `;

          this.resultsContainer.insertBefore(
            resultItem,
            this.resultsContainer.firstChild
          );

          // Limit to 20 results
          while (this.resultsContainer.children.length > 20) {
            this.resultsContainer.removeChild(this.resultsContainer.lastChild);
          }
        }

        clearResults() {
          this.resultsContainer.innerHTML = "";
        }
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", () => {
        new VoiceTranslator();
      });
    </script>
  </body>
</html>
